<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—œè¥¿è·¨å¹´è±ªè¯è¡Œç¨‹ (æ—¥ç³»æ¥µç°¡é¢¨ - Auth Bypass)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* å®šç¾©æ—¥ç³»æ¥µç°¡é¢¨æ ¼çš„é¡è‰²å’Œå­—é«” */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #F8F8F4; /* æ·ºç±³ç™½è‰²/ç´™ç™½è‰²èƒŒæ™¯ */
        }
        /* å®šç¾© Tailwind è‡ªå®šç¾©é¡è‰² */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-green': '#E6F0E6', /* æ·ºç¶ è‰² */
                        'sepia-brown': '#6B4630', /* æ£•è‰² */
                        'header-bg': '#E0E7D6',  /* é é¦–æŸ”å’Œç¶  */
                        'primary-text': '#333333',
                    }
                }
            }
        }

        /* é é¦–åœ“å¼§æ•ˆæœ */
        #app-header {
            position: relative;
            background-color: #E0E7D6; /* é é¦–èƒŒæ™¯è‰² */
            height: 16rem; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´ä½¿ç”¨è€… ID */
            overflow: hidden;
        }
        #app-header::after {
            content: '';
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            height: 100px;
            background-color: #F8F8F4; /* å¿…é ˆèˆ‡ body èƒŒæ™¯è‰²ç›¸åŒ */
            border-top-left-radius: 50%;
            border-top-right-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* ä¸»å…§å®¹å€åŸŸå‘ä¸Šé‡ç–Šï¼Œä¸¦å¢åŠ åº•éƒ¨ padding ä»¥å®¹ç´å›ºå®šå°è¦½åˆ— */
        #main-content {
            position: relative;
            z-index: 10;
            margin-top: -3rem; /* å‘ä¸Šæ‹‰å‹•ä»¥é‡ç–Šåœ“å¼§ */
            padding-bottom: 7rem; /* æ–°å¢: åº•éƒ¨é‚Šè·ï¼Œé¿å…å…§å®¹è¢«å›ºå®šå°è¦½åˆ—é®æ“‹ */
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen">
    <header id="app-header" class="text-center pt-12">
        <h1 class="text-3xl font-bold text-sepia-brown">
            é—œè¥¿è·¨å¹´è¡Œç¨‹
        </h1>
        <p class="mt-1 text-lg text-primary-text/80">
            2025.12.27 ~ 2026.01.02
        </p>

        <div class="mt-4 p-3 mx-auto max-w-sm bg-sepia-brown/10 rounded-xl">
            <p v-if="!isAuthReady" class="text-xs text-sepia-brown font-semibold">
                é€£ç·šä¸­... ğŸŒ
            </p>
            <div v-else class="text-xs text-sepia-brown text-left">
                <p v-if="firebaseInitialized" class="font-semibold text-orange-700">
                    âš ï¸ <span class="text-orange-700">Firestore é€£ç·šå·²å•Ÿç”¨ (éèªè­‰æ¨¡å¼)</span>
                </p>
                <p v-else class="font-semibold text-red-700">
                    âŒ <span class="text-red-700">é€£ç·šå¤±æ•— (é…ç½®æˆ–åˆå§‹åŒ–éŒ¯èª¤)</span>
                </p>
                <p class="mt-1 break-all">
                    æ‚¨çš„å”ä½œ ID: <span class="font-mono text-primary-text/80">{{ userId || 'N/A' }}</span>
                </p>
            </div>
        </div>
        
        </header>

    <main id="main-content" class="max-w-xl mx-auto px-4">
        
        <div v-show="currentTab === 'itinerary'" class="space-y-4">
            
            <div class="overflow-x-scroll hide-scrollbar whitespace-nowrap py-3 sticky top-0 z-30 bg-F8F8F4">
                <div class="inline-flex space-x-3">
                    <div v-for="day in itineraryDays" :key="day.id" 
                         @click="selectDay(day.id)"
                         class="cursor-pointer p-2 rounded-xl text-center transition duration-200"
                         :class="currentDayId === day.id ? 'bg-sepia-brown text-black shadow-md' : 'bg-white text-primary-text border border-soft-green hover:bg-soft-green'"
                    >
                        <span class="font-bold text-sm block">{{ getDayOfWeek(day.date) }}</span>
                        <span class="font-extrabold text-xl leading-none block mt-1">{{ getDayOfMonth(day.date) }}</span>
                    </div>
                </div>
            </div>

            <div v-if="currentDay">
                <div class="bg-white p-4 rounded-xl shadow-lg border border-soft-green mb-4 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <span class="text-3xl" v-html="currentDay.weather.icon"></span>
                        <div>
                            <p class="font-bold text-xl text-primary-text">{{ currentDay.weather.temp }}Â°C</p>
                            <p class="text-xs text-gray-500">é«”æ„Ÿ {{ currentDay.weather.feelsLike }}Â°C</p>
                        </div>
                    </div>
                    <p class="text-sm text-sepia-brown font-semibold">{{ currentDay.weather.location }}</p>
                </div>

                <div class="mb-4 flex space-x-2">
                    <select v-model="filterCategory" class="p-2 border border-soft-green rounded-lg bg-white text-sm text-primary-text focus:border-sepia-brown focus:ring-sepia-brown transition">
                        <option value="">æ‰€æœ‰åˆ†é¡</option>
                        <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                    </select>
                </div>

                <div v-for="(item, index) in filteredItems" :key="item.id" class="mb-4">
                    
                    <div v-if="index > 0 || currentDayId > 1 && index === 0" class="flex items-center justify-center space-x-2 text-sm text-gray-500 my-2">
                         <span v-html="index === 0 ? 'ğŸ ' : item.travelModeIcon"></span>
                        <span class="text-sepia-brown font-semibold">{{ index === 0 ? 'å‰æ—¥ä½å®¿è‡³æ­¤' : item.travelTime }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-soft-green"><line x1="12" y1="5" x2="12" y2="19"/></svg>
                    </div>
                    
                    <div class="day-card bg-white p-4 rounded-xl shadow-md border-l-4 border-sepia-brown/50 transition-all duration-300 hover:shadow-lg">
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-grow">
                                <span class="font-bold text-base block text-sepia-brown">{{ item.time }}</span>
                                <span class="text-lg font-semibold block mt-0.5" :class="item.category === 'èˆªç­' ? 'text-black' : 'text-primary-text'">{{ item.name }}</span>
                            </div>

                            <div class="flex space-x-2">
                                <a 
                                    v-if="item.mapQuery"
                                    :href="getMapLink(item.mapQuery)"
                                    target="_blank"
                                    class="p-1 rounded-full bg-sepia-brown/10 text-sepia-brown hover:bg-gray-500 hover:text-white transition duration-150"
                                    title="Google åœ°åœ–"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
									<circle cx="12" cy="10" r="3"/>
									</svg>
                                </a>
                                <button @click="openEditModal(item, index)" class="p-1 rounded-full bg-sepia-brown/10 text-sepia-brown hover:bg-gray-500 hover:text-white transition duration-150" title="ç·¨è¼¯è¡Œç¨‹">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg>
                                </button>
                            </div>
                        </div>

                        <div v-if="item.category === 'èˆªç­'" class="bg-white p-4 rounded-xl border border-gray-100 mt-2 shadow-inner">
                            
                            <div class="flex justify-between items-start text-primary-text">
                                <div class="w-2/5 text-left">
                                    <p class="text-lg font-bold text-gray-700">{{ item.depCode }}</p> 
                                    <p class="text-base font-medium mt-1">{{ item.depName }}</p>
                                </div>
                                <div class="w-1/5 flex justify-center items-center py-2 text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 4.5C17.3284 3.67157 18.6716 3.67157 19.5 4.5V4.5C20.3284 5.32843 20.3284 6.67157 19.5 7.5L17 10L18.8633 17.4361C18.9482 17.7749 18.8501 18.1335 18.6046 18.382L18.3626 18.6269C17.9174 19.0776 17.1706 19.0059 16.8192 18.4788L13.5 13.5L9.5 17.5V19.5858C9.5 19.851 9.39464 20.1054 9.20711 20.2929L8.92578 20.5742C8.45953 21.0405 7.67757 20.9357 7.35043 20.3633L6 18L3.63675 16.6496C3.06425 16.3224 2.95953 15.5405 3.42578 15.0742L3.70711 14.7929C3.89464 14.6054 4.149 14.5 4.41421 14.5H6.5L10.5 10.5L5.52125 7.18083C4.99413 6.82942 4.92247 6.08263 5.37316 5.63739L5.61816 5.39535C5.86664 5.14987 6.2252 5.05183 6.56401 5.13673L14 7L16.5 4.5Z" stroke="#000000" stroke-width="2"/></svg>
                                </div>
                                <div class="w-2/5 text-right">
                                    <p class="text-lg font-bold text-gray-700">{{ item.arrCode }}</p>
                                    <p class="text-base font-medium mt-1">{{ item.arrName }}</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-end mt-4">
                                <div class="w-1/2 text-left">
                                    <p class="text-xs text-gray-500 font-medium">é è¨ˆ:</p>
                                    <p class="font-extrabold text-5xl text-primary-text leading-none mt-1">{{ item.depTime }}</p>
                                </div>
                                <div class="w-1/2 text-right">
                                    <p class="text-xs text-gray-500 font-medium">é è¨ˆ:</p>
                                    <p class="font-extrabold text-5xl text-primary-text leading-none mt-1">{{ item.arrTime }}</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-3 border-t border-gray-100">
                                <p class="text-xs text-black font-medium">èˆªç­ç·¨è™Ÿ: {{ item.transport }}</p>
                                <p class="text-xs text-primary-text/70 mt-1">{{ item.note }}</p>
                            </div>
                        </div>

                        
                        <div v-else class="text-sm space-y-1 mt-2">
                            <p v-if="item.category === 'æ™¯é»' && item.ticketPrice" class="text-gray-600">é–€ç¥¨: <span class="font-medium text-sepia-brown">{{ item.ticketPrice }} JPY</span></p>
                            <p class="text-gray-600"><span class="font-medium text-primary-text">åˆ†é¡: {{ item.category }}</span></p>
                            <p class="text-xs text-primary-text/70">{{ item.note }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="openAddModal" class="fixed bottom-20 right-6 p-4 rounded-full bg-white text-black shadow-2xl transition hover:text-white hover:bg-gray-500 z-40" title="æ–°å¢è¡Œç¨‹">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>

        </div>

        <div v-show="currentTab === 'exchange'" class="p-6 bg-white rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold text-sepia-brown mb-4">ğŸ’µ åŒ¯ç‡æ›ç®— (JPY â†’ HKD)</h2>
            <div class="text-xs text-red-500 mb-4">* ä½¿ç”¨å›ºå®šæ¨¡æ“¬åŒ¯ç‡: 1 JPY = 0.052 HKD</div>
            
            <div class="space-y-4">
                <div class="flex items-center border-b pb-4">
                    <label for="jpy-input" class="text-lg font-medium w-24">æ—¥åœ“ (JPY):</label>
                    <input type="number" v-model.number="jpyAmount" @input="calculateExchange" id="jpy-input" class="flex-grow p-3 border border-soft-green rounded-lg focus:border-sepia-brown text-lg text-right" placeholder="è¼¸å…¥é‡‘é¡">
                </div>

                <div class="text-center text-sepia-brown font-extrabold text-3xl py-4">
                    =
                </div>
                
                <div class="flex items-center border-t pt-4">
                    <label for="hkd-output" class="text-lg font-medium w-24">æ¸¯å¹£ (HKD):</label>
                    <input type="text" :value="hkdAmount.toFixed(2)" id="hkd-output" readonly class="flex-grow p-3 border border-soft-green rounded-lg bg-soft-green text-lg text-right font-bold">
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'shopping'" class="p-6 bg-white rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold text-sepia-brown mb-6">ğŸ›’ è³¼ç‰©æ¸…å–®</h2>
            
            <form @submit.prevent="addShoppingItem" class="space-y-3 mb-6">
                <input 
                    type="text" 
                    v-model="newShoppingItemForm.name" 
                    placeholder="è¼¸å…¥ç‰©å“åç¨± (å¿…å¡«)" 
                    required 
                    class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown text-lg"
                >
                <input 
                    type="text" 
                    v-model="newShoppingItemForm.note" 
                    placeholder="è¼¸å…¥å‚™è¨» (ä¾‹å¦‚ï¼šè¦è²·çµ¦èª°ã€åœ¨å“ªè£¡è²·)" 
                    class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown text-lg"
                >
                <button 
                    type="submit" 
                    class="w-full p-3 bg-sepia-brown border border-gray-300 text-black rounded-lg hover:bg-green-200 transition font-bold"
                >
                    æ–°å¢è³¼ç‰©é …ç›®
                </button>
            </form>

            <div v-if="itinerary.shoppingList && itinerary.shoppingList.length > 0" class="space-y-3">
                <div 
                    v-for="item in itinerary.shoppingList" 
                    :key="item.id" 
                    class="flex flex-col p-3 bg-soft-green/50 rounded-lg border-l-4 border-sepia-brown/30"
                >
                    <div class="flex justify-between items-start">
                        <p class="text-primary-text font-bold text-lg">{{ item.name }}</p>
                        <button @click="deleteShoppingItem(item.id)" class="text-red-500 hover:text-red-700 transition p-1" title="åˆªé™¤">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                    <p v-if="item.note" class="text-sm text-primary-text/70 mt-1 italic">{{ item.note }}</p>
                </div>
            </div>
            <div v-else class="text-center text-gray-500 py-10">
                æ¸…å–®ç‚ºç©ºã€‚é–‹å§‹æ–°å¢æƒ³è²·çš„ç‰©å“å§ï¼
            </div>
        </div>
    </main>

    <div class="fixed inset-x-0 bottom-0 flex justify-center p-4 z-50">
        <div class="flex bg-white rounded-full shadow-2xl p-3 space-x-6 border border-gray-100">
            <button @click="currentTab = 'itinerary'" :class="tabClass('itinerary')" title="æ¯æ—¥è¡Œç¨‹è¡¨">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
			<line x1="16" y1="2" x2="16" y2="6"/>
			<line x1="8" y1="2" x2="8" y2="6"/>
			<line x1="3" y1="10" x2="21" y2="10"/>
			</svg>
            </button>
            <button @click="currentTab = 'exchange'" :class="tabClass('exchange')" title="åŒ¯ç‡æ›ç®—">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="12" cy="12" r="8"/>
				<line x1="12" y1="8" x2="12" y2="16"/>
				<line x1="8" y1="12" x2="16" y2="12"/>
				<path d="M16 16L19 19L16 22"/>
				<path d="M8 8L5 5L8 2"/>
				</svg>
            </button>
            <button @click="currentTab = 'shopping'" :class="tabClass('shopping')" title="è³¼ç‰©æ¸…å–®">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
            </button>
        </div>
    </div>
    <footer class="text-center py-6 text-xs text-primary-text/50">
        <p>è¡Œç¨‹ç”± AI åŠ©æ‰‹ç”Ÿæˆã€‚è³‡æ–™ç”± Firebase Firestore é›²ç«¯å„²å­˜èˆ‡å³æ™‚åŒæ­¥ã€‚</p>
    </footer>

    <div v-if="isItineraryModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl space-y-4">
            <h3 class="text-xl font-bold text-sepia-brown">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
            <form @submit.prevent="saveItineraryItem" class="space-y-3">
                
                <input type="text" v-model="itineraryForm.name" placeholder="åç¨± (èˆªç­é™¤å¤–)" :required="itineraryForm.category !== 'èˆªç­'" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                <input type="text" v-model="itineraryForm.time" placeholder="æ™‚é–“ (ä¾‹å¦‚: 14:00 - 17:00, èˆªç­é™¤å¤–)" :required="itineraryForm.category !== 'èˆªç­'" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                
                <select v-model="itineraryForm.category" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                    <option disabled value="">è«‹é¸æ“‡åˆ†é¡ (å¿…å¡«)</option>
                    <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                </select>
                
                <div v-if="itineraryForm.category === 'èˆªç­'" class="space-y-3 pt-2 p-3 bg-soft-green/50 rounded-lg">
                    <h4 class="text-sm font-bold text-sepia-brown">èˆªç­ç´°ç¯€ (å–ä»£ä¸Šæ–¹åç¨±/æ™‚é–“)</h4>
                    <input type="text" v-model="itineraryForm.transport" placeholder="èˆªç­ç·¨è™Ÿ (ä¾‹å¦‚: MM 68)" required class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                    <div class="flex space-x-2">
                        <input type="text" v-model="itineraryForm.depCode" placeholder="å‡ºç™¼æ©Ÿå ´ä»£ç¢¼ (ä¾‹å¦‚: HKG)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                        <input type="text" v-model="itineraryForm.arrCode" placeholder="æŠµé”æ©Ÿå ´ä»£ç¢¼ (ä¾‹å¦‚: KIX)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" v-model="itineraryForm.depName" placeholder="å‡ºç™¼åœ°ä¸­æ–‡å (ä¾‹å¦‚: é¦™æ¸¯åœ‹éš›æ©Ÿå ´)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                        <input type="text" v-model="itineraryForm.arrName" placeholder="æŠµé”åœ°ä¸­æ–‡å (ä¾‹å¦‚: é—œè¥¿åœ‹éš›æ©Ÿå ´)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" v-model="itineraryForm.depTime" placeholder="é è¨ˆå‡ºç™¼æ™‚é–“ (ä¾‹å¦‚: 01:45)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                        <input type="text" v-model="itineraryForm.arrTime" placeholder="é è¨ˆæŠµé”æ™‚é–“ (ä¾‹å¦‚: 06:10)" required class="w-1/2 p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                    </div>
                </div>
                <div v-if="itineraryForm.category === 'æ™¯é»'">
                    <input type="number" v-model.number="itineraryForm.ticketPrice" placeholder="é–€ç¥¨åƒ¹æ ¼ (JPY)" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                </div>
                
                <textarea v-model="itineraryForm.note" placeholder="ç‰¹è‰² & å‚™è¨» (ä¾‹å¦‚: æå‰é ç´„)" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown"></textarea>
                
                <input type="text" v-model="itineraryForm.mapQuery" placeholder="Google åœ°åœ–é—œéµå­— (ç”¨æ–¼å°èˆª)" class="w-full p-3 border border-soft-green rounded-lg focus:border-sepia-brown">
                
                <div class="flex space-x-3 pt-2">
                    <button type="button" @click="isItineraryModalOpen = false" class="flex-grow p-3 rounded-xl border border-gray-300 text-primary-text hover:bg-gray-100 transition">å–æ¶ˆ</button>
                    <button type="submit" class="flex-grow p-3 rounded-xl border border-gray-300 bg-sepia-brown text-black hover:bg-green-200 transition">{{ isEditing ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢' }}</button>
                </div>
                
                <button v-if="isEditing" type="button" @click="openConfirmDelete" class="w-full p-3 rounded-xl bg-red-500 text-white hover:bg-red-600 transition mt-2">åˆªé™¤è¡Œç¨‹</button>

            </form>
        </div>
    </div>
    
    <div v-if="isConfirmModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl space-y-4 text-center">
            <h3 class="text-xl font-bold text-sepia-brown">ç¢ºèªæ“ä½œ</h3>
            <p class="text-primary-text">{{ confirmMessage }}</p>
            <div class="flex space-x-3 pt-2">
                <button @click="closeConfirmModal" class="flex-grow p-3 rounded-xl border border-gray-300 text-primary-text hover:bg-gray-100 transition">å–æ¶ˆ</button>
                <button @click="executeConfirmAction" class="flex-grow p-3 rounded-xl bg-red-500 text-white hover:bg-red-600 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>


</div>

<script type="module">
    // å¼•å…¥ Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { createApp, ref, computed, onMounted } = Vue;

    // è¼”åŠ©å‡½æ•¸ï¼šç”Ÿæˆ UUID
    function generateUUID() {
        return crypto.randomUUID();
    }

    // è¼”åŠ©å‡½æ•¸ï¼šå°‡ OpenWeatherMap çš„ç‹€æ…‹ç¢¼è½‰æ›ç‚º emoji
    function getWeatherEmoji(weatherCode) {
        if (weatherCode >= 200 && weatherCode < 300) return 'â›ˆï¸'; // Thunderstorm
        if (weatherCode >= 300 && weatherCode < 500) return 'ğŸŒ§ï¸'; // Drizzle
        if (weatherCode >= 500 && weatherCode < 600) return 'ğŸŒ§ï¸'; // Rain
        if (weatherCode >= 600 && weatherCode < 700) return 'â„ï¸'; // Snow
        if (weatherCode === 800) return 'â˜€ï¸'; // Clear
        if (weatherCode > 800) return 'â˜ï¸'; // Clouds
        return 'ğŸŒ'; // Default
    }

    createApp({
        setup() {
            // ----------------------------------------------------
            // ğŸ”¥ğŸ”¥ğŸ”¥  Canvas ç’°å¢ƒè®Šæ•¸è™•ç†èˆ‡ç¡¬ç·¨ç¢¼å‚™ç”¨é…ç½®  ğŸ”¥ğŸ”¥ğŸ”¥
            // ----------------------------------------------------
            
            // æ‚¨çš„ç¡¬ç·¨ç¢¼é…ç½® (é˜²æ­¢ç’°å¢ƒè®Šæ•¸è§£æå¤±æ•—)
            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyDhH3pTVHmMesGYRnLxXMSOAszXbSuA9fA",
                authDomain: "kansaitripplanner.firebaseapp.com",
                projectId: "kansaitripplanner",
                storageBucket: "kansaitripplanner.firebasestorage.app",
                messagingSenderId: "547034174320",
                appId: "1:547034174320:web:fe6d1a655410fa951075b5",
                measurementId: "G-Q3341W5VVY"
            };

            // 1. å˜—è©¦è§£æç’°å¢ƒè®Šæ•¸
            const envConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {};
            try {
                firebaseConfig = JSON.parse(envConfigString);
            } catch (e) {
                console.warn("è§£æç’°å¢ƒè®Šæ•¸ __firebase_config å¤±æ•—ï¼Œå°‡ä½¿ç”¨ç¡¬ç·¨ç¢¼é…ç½®ä½œç‚º fallbackã€‚", e);
            }

            // 2. æª¢æŸ¥è§£æçµæœã€‚å¦‚æœç„¡æ•ˆï¼Œå‰‡ä½¿ç”¨ç¡¬ç·¨ç¢¼é…ç½®ã€‚
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.log("ç’°å¢ƒé…ç½®ç„¡æ•ˆï¼Œå·²åˆ‡æ›ä½¿ç”¨ç¡¬ç·¨ç¢¼ Firebase é…ç½®ã€‚");
                firebaseConfig = USER_FIREBASE_CONFIG;
            }
            
            // å–å¾—å…¶ä»–ç’°å¢ƒè®Šæ•¸
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // æ‡‰ç”¨ç¨‹å¼ ID

            let db = null;
            // ç”±æ–¼æˆ‘å€‘ä¸å†ä½¿ç”¨ Authï¼Œæˆ‘å€‘ç›´æ¥ç”Ÿæˆä¸€å€‹è‡¨æ™‚ ID
            const userId = ref(generateUUID()); 
            const isAuthReady = ref(false); // åœ¨æœ¬ç‰ˆæœ¬ä¸­ï¼Œé€™ä»£è¡¨ Firebase åˆå§‹åŒ–æ˜¯å¦å®Œæˆ
            const firebaseInitialized = ref(false); // è¿½è¹¤ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ–
            // isTemporaryId åœ¨æ­¤è™•å§‹çµ‚ç‚º trueï¼Œå› ç‚ºæˆ‘å€‘ç¹éäº†èªè­‰
            const isTemporaryId = ref(true); 
            
            // -------------------- OpenWeatherMap ç›¸é—œé…ç½® --------------------
            const OPENWEATHERMAP_API_KEY = "fbe62816684902d7d56067b95729927a"; 
            
            // åŸå¸‚èˆ‡ç¶“ç·¯åº¦æ˜ å°„ï¼ˆç”¨æ–¼ OpenWeatherMap API æŸ¥è©¢ï¼‰
            const CITY_COORDS = {
                'å§¬è·¯': { lat: 34.83, lon: 134.69 }, // å§¬è·¯
                'ç¥æˆ¶': { lat: 34.69, lon: 135.19 }, // ç¥æˆ¶
                'å¤§é˜ª': { lat: 34.69, lon: 135.50 }  // å¤§é˜ª
            };
            
            const TRIP_CITY_MAPPING = {
                1: 'å§¬è·¯', 2: 'å§¬è·¯', 
                3: 'ç¥æˆ¶', 4: 'ç¥æˆ¶', 
                5: 'å¤§é˜ª', 6: 'å¤§é˜ª', 7: 'å¤§é˜ª'
            };
            // -------------------- OpenWeatherMap é…ç½®çµæŸ --------------------


            // -------------------- æ•¸æ“šç‹€æ…‹ --------------------
            const currentTab = ref('itinerary');
            const currentDayId = ref(1);
            const categories = ['æ™¯é»', 'ä½å®¿', 'ç¾é£Ÿ', 'è³¼ç‰©', 'èˆªç­', 'äº¤é€š', 'å…¶ä»–'];

            // Modal ç‹€æ…‹
            const isItineraryModalOpen = ref(false);
            const isEditing = ref(false);
            const editingIndex = ref(null);

            // è‡ªå®šç¾©ç¢ºèª Modal ç‹€æ…‹
            const isConfirmModalOpen = ref(false);
            const confirmMessage = ref('');
            const confirmAction = ref(null); 

            // ğŸ“Œ è¡Œç¨‹è¡¨å–®æ•¸æ“š (å¾ form.value è®Šæ›´åç¨±ç‚º itineraryForm)
            const itineraryForm = ref({});
            
            // ğŸ“Œ è³¼ç‰©æ¸…å–®è¡¨å–®æ•¸æ“š (æ–°çš„è®Šæ•¸)
            const newShoppingItemForm = ref({ name: '', note: '' });

            // æ•¸æ“šå„²å­˜ç‹€æ…‹ (å¾ Firestore è¼‰å…¥)
            // itinerary.value åŒ…å« { shoppingList: [], days: [] }
            const itinerary = ref({ days: [], shoppingList: [] }); 

            // åŒ¯ç‡æ›ç®—ç‹€æ…‹
            const JPY_TO_HKD_RATE = 0.052; // æ¨¡æ“¬åŒ¯ç‡
            const jpyAmount = ref(10000);
            const hkdAmount = ref(jpyAmount.value * JPY_TO_HKD_RATE);


            // -------------------- å¯¦æ™‚è¨ˆç®—å±¬æ€§ --------------------
            const itineraryDays = computed(() => itinerary.value.days || []);

            const currentDay = computed(() => {
                return itineraryDays.value.find(day => day.id === currentDayId.value);
            });

            const filterCategory = ref('');
            const filteredItems = computed(() => {
                let items = currentDay.value ? currentDay.value.items : [];
                if (filterCategory.value) {
                    items = items.filter(item => item.category === filterCategory.value);
                }
                return items;
            });
            
            // -------------------- Firebase æ ¸å¿ƒåŠŸèƒ½ --------------------
            
            // å–å¾— Firestore Document Reference (å…¬å…±è³‡æ–™è·¯å¾‘)
            const getItineraryDocRef = () => {
                // å…¬å…±å”ä½œè·¯å¾‘: /artifacts/{appId}/public/data/itineraries/main-trip
                return doc(db, `artifacts/${appId}/public/data/itineraries`, 'main-trip');
            };

            // å„²å­˜/æ›´æ–°è¡Œç¨‹ (å°‡æ•´å€‹è¡Œç¨‹ç‰©ä»¶å¯«å…¥å–®ä¸€æ–‡ä»¶)
            // ç”±æ–¼æ²’æœ‰ Authï¼Œæˆ‘å€‘å¿…é ˆä¾è³´ Firestore è¦å‰‡å…è¨±ç„¡èªè­‰ç”¨æˆ¶å¯«å…¥å…¬å…±è³‡æ–™ã€‚
            const saveItineraryData = async () => {
                if (!db || !firebaseInitialized.value) {
                    console.warn("Firestore æœªåˆå§‹åŒ–æˆ–é€£ç·šå¤±æ•—ï¼Œç„¡æ³•å„²å­˜è³‡æ–™ã€‚");
                    return;
                }

                try {
                    await setDoc(getItineraryDocRef(), itinerary.value, { merge: true });
                    console.log("è¡Œç¨‹è³‡æ–™å·²æˆåŠŸåŒæ­¥åˆ° Firestore!");
                } catch (e) {
                    console.error("åŒæ­¥è¡Œç¨‹è³‡æ–™åˆ° Firestore å¤±æ•— (è«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å…è¨±æœªèªè­‰ç”¨æˆ¶å¯«å…¥å…¬å…±è·¯å¾‘): ", e);
                }
            };

            // è¨­ç½®å³æ™‚ç›£è½å™¨
            const setupRealtimeListeners = () => {
                if (!db || !firebaseInitialized.value) return;
                
                const docRef = getItineraryDocRef();
                
                // Firestore ç›£è½å™¨
                onSnapshot(docRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        
                        // ç¢ºä¿è³‡æ–™çµæ§‹çš„å®Œæ•´æ€§ (åŒ…æ‹¬ shoppingList)
                        if (!data.days) data.days = [];
                        if (!data.shoppingList) data.shoppingList = [];
                        
                        itinerary.value = data;
                        
                        // ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´ (å¦‚æœ Firestore æ–‡ä»¶é‚„ä¸å­˜åœ¨)
                        if (itinerary.value.days.length === 0) {
                            itinerary.value = initializeItineraryData();
                            saveItineraryData(); // å˜—è©¦å¯«å…¥åˆå§‹åŒ–è³‡æ–™
                        }
                        
                        // æ¯æ¬¡è³‡æ–™æ›´æ–°å¾Œå˜—è©¦ç²å–å¤©æ°£
                        updateWeatherForTrip();
                        
                    } else {
                        // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯«å…¥åˆå§‹åŒ–è³‡æ–™
                        itinerary.value = initializeItineraryData();
                        saveItineraryData();
                    }
                }, (error) => {
                    console.error("ç›£è½è¡Œç¨‹è³‡æ–™å¤±æ•— (å¯èƒ½æ˜¯ Firestore è¦å‰‡é˜»æ­¢äº†è®€å–): ", error);
                });
            };

            // -------------------- OpenWeatherMap ç²å–å‡½æ•¸ --------------------

            const updateWeatherForTrip = async () => {
                console.log("å˜—è©¦æ›´æ–° OpenWeatherMap å¤©æ°£æ•¸æ“š...");
                const cityWeather = {}; // æš«å­˜æ¯å€‹åŸå¸‚çš„å¤©æ°£æ•¸æ“š

                // éæ­·æ‰€æœ‰åŸå¸‚ï¼ŒéåŒæ­¥ç²å–ç•¶å‰å¤©æ°£
                for (const city of Object.keys(CITY_COORDS)) {
                    try {
                        const { lat, lon } = CITY_COORDS[city];
                        // ç¢ºä¿ lang=zh_tw
                        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHERMAP_API_KEY}&units=metric&lang=zh_tw`;
                        
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        
                        // å„²å­˜æ ¸å¿ƒå¤©æ°£è³‡è¨Š
                        cityWeather[city] = {
                            icon: getWeatherEmoji(data.weather[0].id),
                            temp: Math.round(data.main.temp),
                            feelsLike: Math.round(data.main.feels_like),
                            // å¼·åˆ¶ä½¿ç”¨æ‚¨åœ¨ CITY_COORDS ä¸­å®šç¾©çš„ä¸­æ–‡åŸå¸‚åç¨±
                            location: city 
                        };
                        console.log(`æˆåŠŸç²å– ${city} å¤©æ°£ã€‚`);
                    } catch (error) {
                        console.error(`ç²å– ${city} å¤©æ°£å¤±æ•—:`, error);
                        // å¤±æ•—æ™‚ä½¿ç”¨é è¨­/æ¨¡æ“¬å€¼
                        cityWeather[city] = { icon: 'â“', temp: 'N/A', feelsLike: 'N/A', location: city };
                    }
                }
                
                // å°‡ç²å–åˆ°çš„å¤©æ°£æ‡‰ç”¨åˆ°æ¯å¤©çš„è¡Œç¨‹ä¸­
                itinerary.value.days = itinerary.value.days.map(day => {
                    const city = TRIP_CITY_MAPPING[day.id];
                    if (city && cityWeather[city]) {
                        day.weather = cityWeather[city];
                    } else {
                        // å¦‚æœæ˜ å°„å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼
                        day.weather = { icon: 'â“', temp: 'N/A', feelsLike: 'N/A', location: 'æœªçŸ¥åœ°å€' };
                    }
                    return day;
                });
                
                // ç”±æ–¼å¤©æ°£æ˜¯å³æ™‚æ•¸æ“šï¼Œæˆ‘å€‘ä¸ä¸»å‹•å°‡å…¶å¯«å› Firestoreï¼Œåªæ›´æ–°æœ¬åœ° UI
            };


            // -------------------- å¼·åŒ–åˆå§‹åŒ–é‚è¼¯ (ç§»é™¤ Auth) --------------------
            const initFirebaseAndDatabase = async () => {
                setLogLevel('Debug');
                isAuthReady.value = false;
                firebaseInitialized.value = false;

                try {
                    // 1. å˜—è©¦åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
                    if (!firebaseConfig.apiKey) {
                        throw new Error("é…ç½®éŒ¯èª¤: éºå¤±æˆ–ç„¡æ•ˆçš„ apiKeyã€‚");
                    }

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    firebaseInitialized.value = true; // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–æˆåŠŸ

                    // 2. è¨­ç½®ç›£è½å™¨
                    setupRealtimeListeners(); 

                } catch (initError) {
                    // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•— (é…ç½®å•é¡Œæˆ–ç¶²è·¯å•é¡Œ)
                    console.error("Firebase App åˆå§‹åŒ–å¤±æ•—:", initError);
                    firebaseInitialized.value = false; 
                } finally {
                    isAuthReady.value = true; // æ¨™è¨˜ç‚ºå·²å®Œæˆåˆå§‹åŒ–æµç¨‹
                }
            };

            // -------------------- æ–¹æ³• --------------------

            // æ¨£å¼è¼”åŠ©æ–¹æ³•
            const tabClass = (tabName) => {
                const base = 'p-2 rounded-full transition duration-200';
                return currentTab.value === tabName
                    ? `${base} bg-soft-green text-sepia-brown`
                    : `${base} text-primary-text/60 hover:text-sepia-brown`;
            };

            // æ—¥æœŸè¼”åŠ©æ–¹æ³•
            const getDayOfWeek = (date) => new Date(date).toLocaleDateString('zh-TW', { weekday: 'short' });
            const getDayOfMonth = (date) => new Date(date).getDate();

            const selectDay = (dayId) => {
                currentDayId.value = dayId;
                filterCategory.value = ''; // åˆ‡æ›æ—¥æœŸæ™‚é‡ç½®åˆ†é¡
            };

            // ä¿®æ­£ Google Map é€£çµä¸­çš„éŒ¯èª¤ (ä¿®æ­£ç·¨ç¢¼å•é¡Œ)
            const getMapLink = (query) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;

            const calculateExchange = () => {
                hkdAmount.value = jpyAmount.value * JPY_TO_HKD_RATE;
            };

            // -------------------- è‡ªå®šç¾©ç¢ºèª Modal é‚è¼¯ (å–ä»£ window.confirm) --------------------
            const openConfirmModal = (message, action) => {
                confirmMessage.value = message;
                confirmAction.value = action;
                isConfirmModalOpen.value = true;
            };

            const closeConfirmModal = () => {
                isConfirmModalOpen.value = false;
                confirmAction.value = null;
            };

            const executeConfirmAction = () => {
                if (confirmAction.value) {
                    confirmAction.value();
                }
                closeConfirmModal();
            };
            
            const openConfirmDelete = () => {
                openConfirmModal('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', deleteItineraryItem);
            };

            // -------------------- è³¼ç‰©æ¸…å–® CRUD å‡½æ•¸ --------------------

            const addShoppingItem = () => {
                if (newShoppingItemForm.value.name.trim() !== '') {
                    // ç¢ºä¿ shoppingList å­˜åœ¨
                    if (!itinerary.value.shoppingList) {
                        itinerary.value.shoppingList = [];
                    }
                    itinerary.value.shoppingList.push({
                        id: generateUUID(),
                        name: newShoppingItemForm.value.name.trim(),
                        // ğŸ“Œ å¼•å…¥å‚™è¨»æ¬„ä½
                        note: newShoppingItemForm.value.note.trim()
                    });
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    newShoppingItemForm.value.name = ''; 
                    newShoppingItemForm.value.note = '';
                    
                    saveItineraryData();
                }
            };

            const deleteShoppingItem = (id) => {
                openConfirmModal('ç¢ºå®šè¦åˆªé™¤æ­¤è³¼ç‰©é …ç›®å—ï¼Ÿ', () => {
                    if (itinerary.value.shoppingList) {
                        const index = itinerary.value.shoppingList.findIndex(item => item.id === id);
                        if (index !== -1) {
                            itinerary.value.shoppingList.splice(index, 1);
                            saveItineraryData();
                        }
                    }
                });
            };
            
            // -------------------- è¡Œç¨‹ CRUD --------------------
            const openAddModal = () => {
                // åˆå§‹åŒ–æ‰€æœ‰æ¬„ä½ï¼ŒåŒ…æ‹¬æ–°çš„èˆªç­å°ˆå±¬æ¬„ä½
                itineraryForm.value = { 
                    id: generateUUID(), 
                    name: '', 
                    time: '', 
                    category: categories[0], 
                    note: '', 
                    mapQuery: '', 
                    ticketPrice: null, 
                    travelTime: '30åˆ†é˜', 
                    travelModeIcon: 'ğŸš¶',
                    // æ–°å¢èˆªç­å°ˆå±¬æ¬„ä½
                    transport: '',
                    depCode: '',
                    arrCode: '',
                    depName: '',
                    isEditing: false, // ç¢ºä¿æ¯æ¬¡æ–°å¢éƒ½æ˜¯ false
                    arrName: '',
                    depTime: '',
                    arrTime: ''
                };
                isEditing.value = false;
                isItineraryModalOpen.value = true;
            };

            const openEditModal = (item, index) => {
                // ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦è¤‡è£½æ‰€æœ‰å±¬æ€§ï¼ŒåŒ…æ‹¬æ–°çš„èˆªç­å±¬æ€§
                itineraryForm.value = { ...item }; 
                editingIndex.value = index;
                isEditing.value = true;
                isItineraryModalOpen.value = true;
            };

            const saveItineraryItem = () => {
                if (!currentDay.value) return;
                
                if (!firebaseInitialized.value) {
                    console.warn("Firestore æœªé€£ç·šï¼Œæ–°å¢/ç·¨è¼¯æ“ä½œåƒ…é©ç”¨æ–¼æœ¬åœ°ã€‚");
                }
                
                // è™•ç†éèˆªç­é …ç›®çš„é è¨­å€¼
                if (itineraryForm.value.category !== 'èˆªç­') {
                    if (itineraryForm.value.category === 'æ™¯é»' && !itineraryForm.value.ticketPrice) itineraryForm.value.ticketPrice = 0;
                    
                    if (!itineraryForm.value.travelTime || itineraryForm.value.travelTime === '0åˆ†é˜') {
                        itineraryForm.value.travelTime = 'ç´„ 30 åˆ†é˜';
                        itineraryForm.value.travelModeIcon = itineraryForm.value.category === 'ä½å®¿' ? 'ğŸšŒ' : 'ğŸš¶';
                    }
                } else {
                    // èˆªç­é …ç›®é è¨­äº¤é€šè³‡è¨Š
                    itineraryForm.value.travelTime = '0åˆ†é˜';
                    itineraryForm.value.travelModeIcon = 'âœˆï¸';
                    // æ ¹æ“šæ–°çš„æ¬„ä½è¨­å®š name å’Œ timeï¼Œä»¥ä¾›åˆ—è¡¨é ‚éƒ¨é¡¯ç¤ºå’Œæ’åº
                    itineraryForm.value.name = `${itineraryForm.value.depCode} â†’ ${itineraryForm.value.arrCode} (${itineraryForm.value.transport})`;
                    itineraryForm.value.time = `${itineraryForm.value.depTime} - ${itineraryForm.value.arrTime}`;
                }


                if (isEditing.value) {
                    // æ›´æ–°ç¾æœ‰é …ç›®
                    currentDay.value.items[editingIndex.value] = itineraryForm.value;
                } else {
                    // æ–°å¢é …ç›®
                    currentDay.value.items.push(itineraryForm.value);
                    // ç¢ºä¿æ’åºå¾Œå†å„²å­˜
                    currentDay.value.items.sort((a, b) => {
                        // ç°¡å–®çš„æ™‚é–“å­—ä¸²æ’åº (time å°æ–¼èˆªç­ä¹Ÿæ˜¯ depTime - arrTime)
                        return a.time.localeCompare(b.time);
                    });
                }

                saveItineraryData(); // å˜—è©¦å„²å­˜åˆ° Firestore
                isItineraryModalOpen.value = false;
            };

            const deleteItineraryItem = () => {
                if (currentDay.value && editingIndex.value !== null) {
                    if (!firebaseInitialized.value) {
                        console.warn("Firestore æœªé€£ç·šï¼Œåˆªé™¤æ“ä½œåƒ…é©ç”¨æ–¼æœ¬åœ°ã€‚");
                    }
                    currentDay.value.items.splice(editingIndex.value, 1);
                    saveItineraryData(); // å˜—è©¦å„²å­˜åˆ° Firestore
                    isItineraryModalOpen.value = false;
                }
            };
            
            // -------------------- åˆå§‹æ•¸æ“š (æ›´æ–°è³¼ç‰©æ¸…å–®æ•¸æ“šçµæ§‹) --------------------
            const initializeItineraryData = () => {
                return {
                    // ğŸ“Œ è³¼ç‰©æ¸…å–®é è¨­å€¼ (å·²åŠ å…¥ note å‚™è¨»)
                    shoppingList: [
                        { id: generateUUID(), name: 'ç™½è‰²æˆ€äºº (12 å…¥)', note: 'å¿…è²·ï¼è²·çµ¦åª½åª½å’ŒåŒäº‹' },
                        { id: generateUUID(), name: 'Pocky (åœ°å€é™å®š)', note: 'åªè²·å®‡æ²»æŠ¹èŒ¶å£å‘³' },
                        { id: generateUUID(), name: 'çºç¥­ æ¸…é…’', note: '720ml ä¸€ç“¶ï¼Œå¸¶å›é¦™æ¸¯' },
                    ],
                    days: [
                        { id: 1, date: '2025-12-27', title: 'æŠµé”èˆ‡å§¬è·¯éŠ', weather: { location: 'å§¬è·¯' }, items: [
                            // èˆªç­æ•¸æ“šçµæ§‹
                            { 
                                id: generateUUID(), 
                                time: '01:45 - 06:10', 
                                name: 'HKG â†’ KIX', 
                                category: 'èˆªç­', 
                                note: 'é ˜å–è¡Œæ', 
                                mapQuery: 'é—œè¥¿åœ‹éš›æ©Ÿå ´ KIX', 
                                travelTime: '0åˆ†é˜', 
                                travelModeIcon: 'âœˆï¸', 
                                transport: 'MM 68',
                                depCode: 'HKG',
                                arrCode: 'KIX',
                                depName: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´',
                                arrName: 'é—œè¥¿åœ‹éš›æ©Ÿå ´',
                                depTime: '01:45',
                                arrTime: '06:10'
                            },
                            { id: generateUUID(), time: '08:50 - 11:10', name: 'KIX â†’ å§¬è·¯ç«™', category: 'äº¤é€š', note: 'KIX T1 6 è™Ÿä¹˜è»Šè™•', mapQuery: 'å§¬è·¯ç«™', travelTime: '150åˆ†é˜', travelModeIcon: 'ğŸšŒ' },
                            { id: generateUUID(), time: '11:10 - 12:00', name: 'Richmond Hotel Himeji', category: 'ä½å®¿', note: 'è¾¦ç†å…¥ä½/å¯„æ”¾è¡Œæ', mapQuery: 'Richmond Hotel Himeji', travelTime: '15åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '14:00 - 17:00', name: 'æ›¸å¯«å±±åœ“æ•™å¯º éŠè¦½', category: 'æ™¯é»', note: 'é ç•™ 3 å°æ™‚', mapQuery: 'æ›¸å¯«å±±åœ“æ•™å¯º', ticketPrice: 500, travelTime: '60åˆ†é˜', travelModeIcon: 'ğŸšŒ' },
                            { id: generateUUID(), time: '19:30 onwards', name: 'æ™šé¤', category: 'ç¾é£Ÿ', note: 'å¯åœ¨å§¬è·¯ç«™å‘¨é‚Šå°‹æ‰¾', mapQuery: 'å§¬è·¯ç«™ ç¾é£Ÿ', travelTime: '15åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                        ]},
                        { id: 2, date: '2025-12-28', title: 'å§¬è·¯æ·±åº¦éŠ', weather: { location: 'å§¬è·¯' }, items: [
                            { id: generateUUID(), time: '09:00 - 12:00', name: 'å§¬è·¯åŸ', category: 'æ™¯é»', note: 'ä¸–ç•Œæ–‡åŒ–éºç”¢ï¼Œå»ºè­°é–‹åœ’æ™‚å…¥å ´', mapQuery: 'å§¬è·¯åŸ', ticketPrice: 1000, travelTime: '10åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '13:30 - 16:00', name: 'å¥½å¤åœ’', category: 'æ™¯é»', note: 'æ—¥å¼åº­åœ’ï¼Œå»ºè­°è³¼è²·è¯ç¥¨', mapQuery: 'å¥½å¤åœ’', ticketPrice: 300, travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '18:30 onwards', name: 'æ™šé¤', category: 'ç¾é£Ÿ', note: 'çºŒä½ Richmond Hotel Himeji', mapQuery: 'å§¬è·¯ ç¾é£Ÿæ¨è–¦', travelTime: '15åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                        ]},
                        { id: 3, date: '2025-12-29', title: 'ç¥æˆ¶è³¼ç‰©èˆ‡å¨›æ¨‚æ—¥', weather: { location: 'ç¥æˆ¶' }, items: [
                            { id: generateUUID(), time: '09:30 - 10:35', name: 'å§¬è·¯ â†’ ç¥æˆ¶ä¸‰å®®', category: 'äº¤é€š', note: 'å±±é™½ç›´é€šç‰¹æ€¥', mapQuery: 'ç¥æˆ¶ä¸‰å®®ç«™', travelTime: '70åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            { id: generateUUID(), time: '10:35 - 11:00', name: 'BRENZA HOTEL', category: 'ä½å®¿', note: 'å¯„æ”¾è¡Œæ', mapQuery: 'BRENZA HOTEL', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '12:30 - 14:00', name: 'Steakland ç¥æˆ¶ç‰›åˆé¤', category: 'ç¾é£Ÿ', note: 'å‹™å¿…æå‰é ç´„', mapQuery: 'Steakland Kobe', travelTime: '10åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '14:00 - 19:00', name: 'è³¼ç‰©èˆ‡å¤¾å…¬ä»”', category: 'è³¼ç‰©', note: 'ä¸‰å®®ä¸­å¿ƒè¡— & GiGO/Taito Station', mapQuery: 'ç¥æˆ¶ä¸‰å®®ä¸­å¿ƒè¡—', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '19:00 - 20:30', name: 'MOSAIC å»£å ´æ™šé¤', category: 'ç¾é£Ÿ', note: 'æ¬£è³å¤œæ™¯', mapQuery: 'ç¥æˆ¶ é¦¬è³½å…‹å»£å ´', travelTime: '20åˆ†é˜', travelModeIcon: 'ğŸšŒ' },
                        ]},
                        { id: 4, date: '2025-12-30', title: 'å…­ç”²å±±èˆ‡æœ‰é¦¬æº«æ³‰', weather: { location: 'ç¥æˆ¶' }, items: [
                            { id: generateUUID(), time: '09:00 - 11:00', name: 'ä¸‰å®® â†’ å…­ç”²å±±é ‚', category: 'äº¤é€š', note: 'JR â†’ å·´å£« â†’ çºœè»Š', mapQuery: 'å…­ç”²å±±é ‚', travelTime: '90åˆ†é˜', travelModeIcon: 'ğŸšŒ' },
                            { id: generateUUID(), time: '13:00 - 14:00', name: 'å…­ç”²å±± â†’ æœ‰é¦¬æº«æ³‰', category: 'äº¤é€š', note: 'å…­ç”²æœ‰é¦¬çºœè»Š', mapQuery: 'æœ‰é¦¬æº«æ³‰', travelTime: '30åˆ†é˜', travelModeIcon: 'ğŸš ' },
                            { id: generateUUID(), time: '14:00 - 17:30', name: 'æœ‰é¦¬æº«æ³‰ é«”é©—', category: 'æ™¯é»', note: 'é«”é©—é‡‘/éŠ€ä¹‹æ¹¯', mapQuery: 'æœ‰é¦¬æº«æ³‰ é‡‘ä¹‹æ¹¯', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶', ticketPrice: 850 },
                            { id: generateUUID(), time: '17:30 - 19:00', name: 'è¿”å›ç¥æˆ¶ä¸‰å®®', category: 'äº¤é€š', note: 'å·´å£«æˆ–ç¥æˆ¶é›»éµ', mapQuery: 'ç¥æˆ¶ä¸‰å®®ç«™', travelTime: '60åˆ†é˜', travelModeIcon: 'ğŸšŒ' },
                        ]},
                        { id: 5, date: '2025-12-31', title: 'å¤§é˜ª USJ è·¨å¹´æ´¾å°', weather: { location: 'å¤§é˜ª' }, items: [
                            { id: generateUUID(), time: '09:30 - 10:35', name: 'ç¥æˆ¶ â†’ æ·€å±‹æ©‹', category: 'äº¤é€š', note: 'é˜ªç¥ â†’ åœ°éµ', mapQuery: 'æ·€å±‹æ©‹äº¬é˜ªé£¯åº—', travelTime: '60åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            { id: generateUUID(), time: '10:35 - 11:00', name: 'BRENZA HOTEL', category: 'ä½å®¿', note: 'å¯„æ”¾è¡Œæ', mapQuery: 'BRENZA HOTEL', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '12:30 - 14:00', name: 'æ·€å±‹æ©‹ â†’ ç’°çƒåŸ', category: 'äº¤é€š', note: 'åœ°éµ â†’ JR', mapQuery: 'ç’°çƒåŸç«™', travelTime: '45åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            { id: generateUUID(), time: '17:00 - 00:30', name: 'USJ è·¨å¹´æ´¾å°', category: 'æ™¯é»', note: 'ç«‹å³æŠ½é¸ç‘ªåˆ©æ­å€æ•´ç†åˆ¸ï¼', mapQuery: 'æ—¥æœ¬ç’°çƒå½±åŸ', ticketPrice: 9800, travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                        ]},
                        { id: 6, date: '2026-01-01', title: 'USJ çºŒæ”¤èˆ‡ä¼‘æ•´æ—¥', weather: { location: 'å¤§é˜ª' }, items: [
                            { id: generateUUID(), time: '02:00 - 06:00', name: 'SNW ç‘ªåˆ©æ­å€', category: 'æ™¯é»', note: 'é»ƒé‡‘æ™‚æ®µï¼Œäººæ½®æœ€å°‘', mapQuery: 'è¶…ç´šä»»å¤©å ‚ä¸–ç•Œ', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶', ticketPrice: 0 },
                            { id: generateUUID(), time: '09:00 - 10:00', name: 'è¿”å›æ·€å±‹æ©‹é£¯åº—', category: 'äº¤é€š', note: 'JR â†’ åœ°éµ', mapQuery: 'æ·€å±‹æ©‹äº¬é˜ªé£¯åº—', travelTime: '45åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            { id: generateUUID(), time: '10:00 - 16:00', name: 'é•·è·é›¢ä¼‘æ¯èˆ‡è£œçœ ', category: 'ä½å®¿', note: 'æ¢å¾©é«”åŠ›', mapQuery: 'æ·€å±‹æ©‹äº¬é˜ªé£¯åº—', travelTime: '0åˆ†é˜', travelModeIcon: 'ğŸ›Œ' },
                            { id: generateUUID(), time: '16:00 - 18:00', name: 'ä¸­ä¹‹å³¶ è¼•é¬†æ•£æ­¥', category: 'å…¶ä»–', note: 'é£¯åº—å‘¨é‚Šæ­¥è¡Œå¯é”', mapQuery: 'ä¸­ä¹‹å³¶å…¬åœ’', travelTime: '15åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                        ]},
                        { id: 7, date: '2026-01-02', title: 'è§€å…‰èˆ‡è¿”ç¨‹æ—¥', weather: { location: 'å¤§é˜ª' }, items: [
                            { id: generateUUID(), time: '09:30 - 12:30', name: 'å¤§é˜ªæµ·éŠé¤¨åƒè§€', category: 'æ™¯é»', note: 'æ­ä¹˜åœ°éµ', mapQuery: 'å¤§é˜ªæµ·éŠé¤¨', ticketPrice: 2700, travelTime: '30åˆ†é˜', travelModeIcon: 'ğŸš‡' },
                            { id: generateUUID(), time: '13:30 - 14:30', name: 'æµ·éŠé¤¨ â†’ è‡¨ç©ºåŸ', category: 'äº¤é€š', note: 'JR/å—æµ·é›»éµ', mapQuery: 'è‡¨ç©ºåŸ Premium Outlet', travelTime: '60åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            { id: generateUUID(), time: '14:30 - 18:00', name: 'è‡¨ç©ºåŸ Outlet è³¼ç‰©', category: 'è³¼ç‰©', note: 'è¿”ç¨‹å‰æœ€å¾Œè¡€æ‹¼', mapQuery: 'è‡¨ç©ºåŸ Premium Outlet', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš¶' },
                            { id: generateUUID(), time: '18:00 - 18:30', name: 'è‡¨ç©ºåŸ â†’ KIX', category: 'äº¤é€š', note: 'è»Šç¨‹ 5 åˆ†é˜', mapQuery: 'é—œè¥¿åœ‹éš›æ©Ÿå ´ KIX', travelTime: '5åˆ†é˜', travelModeIcon: 'ğŸš†' },
                            // èˆªç­æ•¸æ“šçµæ§‹
                            { 
                                id: generateUUID(), 
                                time: '21:05 - 23:35', 
                                name: 'KIX â†’ é¦™æ¸¯ HKG (MM 67)', 
                                category: 'èˆªç­', 
                                note: 'é ç•™å……è¶³æ™‚é–“è¾¦ç†æ‰‹çºŒ', 
                                mapQuery: 'é—œè¥¿åœ‹éš›æ©Ÿå ´ KIX', 
                                travelTime: '0åˆ†é˜', 
                                travelModeIcon: 'âœˆï¸', 
                                transport: 'MM 67',
                                depCode: 'KIX',
                                arrCode: 'HKG',
                                depName: 'é—œè¥¿åœ‹éš›æ©Ÿå ´',
                                arrName: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´',
                                depTime: '21:05',
                                arrTime: '23:35'
                            },
                        ]}
                    ]
                }; // æ›´æ”¹ç‚ºè¿”å›ç‰©ä»¶
            };

            // -------------------- åˆå§‹åŒ– --------------------
            onMounted(() => {
                // å‘¼å«åˆå§‹åŒ–å‡½æ•¸
                initFirebaseAndDatabase(); 
                calculateExchange(); 
                // åœ¨åˆå§‹åŒ–å¾Œå˜—è©¦ç²å–ä¸¦æ‡‰ç”¨å¤©æ°£æ•¸æ“š
                // æ³¨æ„: initializeItineraryData ç¾åœ¨è¿”å›ä¸€å€‹åŒ…å« days å’Œ shoppingList çš„ç‰©ä»¶
                if (itinerary.value.days.length === 0) {
                    const initialData = initializeItineraryData();
                    itinerary.value.days = initialData.days;
                    itinerary.value.shoppingList = initialData.shoppingList;
                    updateWeatherForTrip();
                }
            });

            return {
                currentTab,
                currentDayId,
                categories,
                isItineraryModalOpen,
                isEditing,
                // ğŸ“Œ æš´éœ²æ–°çš„è¡¨å–®è®Šæ•¸
                itineraryForm, 
                newShoppingItemForm, 
                itineraryDays, 
                jpyAmount,
                hkdAmount,
                tabClass,
                getDayOfWeek,
                getDayOfMonth,
                selectDay,
                currentDay,
                filterCategory,
                filteredItems,
                getMapLink,
                calculateExchange,
                openAddModal,
                openEditModal,
                saveItineraryItem,
                openConfirmDelete, 
                // Firebase ç‹€æ…‹ (å·²ç§»é™¤ Auth)
                userId,
                isAuthReady,
                isTemporaryId,
                firebaseInitialized, 
                // è‡ªå®šç¾©ç¢ºèª Modal 
                isConfirmModalOpen,
                confirmMessage,
                closeConfirmModal,
                executeConfirmAction,
                // è³¼ç‰©æ¸…å–®ç›¸é—œç‹€æ…‹å’Œæ–¹æ³•
                addShoppingItem,
                deleteShoppingItem,
                itinerary, // æš´éœ² itinerary ä»¥ä¾›è³¼ç‰©æ¸…å–®åˆ—è¡¨ä½¿ç”¨
            };
        }
    }).mount('#app');
</script>

</body>
</html>
